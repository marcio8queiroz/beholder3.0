# Corrigindo o erro de sintaxe 'bash: erro de sintaxe próximo ao token inesperado ('
# Removendo a linha '#version: '3.8'' pois o compose não precisa dela.

services:
  # 1. Serviço do Banco de Dados MySQL
  mysqldb:
    image: mysql:8.0 # Versão estável do MySQL
    container_name: mysql_db_bot
    restart: always
    environment:
      # Variáveis usadas pelo container do MySQL
      MYSQL_ROOT_PASSWORD: ${DB_PWD}      # Senha do usuário root
      MYSQL_DATABASE: ${DB_NAME}          # Nome do banco de dados a ser criado
      MYSQL_USER: ${DB_USER}              # Usuário que sua app usará
      MYSQL_PASSWORD: ${DB_PWD}           # Senha do usuário da sua app
    ports:
      # Mapeia a porta do container (3306) para a sua máquina local (3306)
      - "3306:3306"
    volumes:
      # Isso persiste os dados do banco, para não perdê-los ao parar o container
      - db_data:/var/lib/mysql

  # 2. Serviço da Aplicação Node.js (seu backend)
  node_app:
    build: 
      context: .
      dockerfile: Dockerfile # Assume que o Dockerfile do backend ainda se chama 'Dockerfile' na raiz
    container_name: binance_bot_app
    restart: always
    depends_on:
      - mysqldb

    working_dir: /usr/src/app 

    environment:
      # Variáveis de ambiente que seu db.js precisa:
      DB_HOST: mysqldb          # CRÍTICO: O host é o nome do serviço do Docker Compose
      DB_PORT: 3306             # Porta interna do container do MySQL
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PWD: ${DB_PWD}
      DB_DIALECT: mysql
      NODE_ENV: development     

    ports:
      # Mapeia a porta da sua aplicação (3001) para a sua máquina local (3001)
      - "3001:3001"

    volumes:
      - ./backend:/usr/src/app 

  # 3. Serviço da Aplicação Frontend (Vite/React)
  frontend_app:
    build: 
      context: .
      dockerfile: Dockerfile.frontend
    container_name: beholder30-frontend_app
    restart: always
    depends_on:
      - node_app # Depende do backend para se conectar à API
    
    working_dir: /usr/src/app
    
    # IMPORTANTE: Garante que o frontend se conecte ao backend via o host, 
    # e que o Vite inicie corretamente.
    environment:
      # VITE_API_URL: http://localhost:3001 (Esta variável é injetada via frontend/.env)
      NODE_ENV: development

    ports:
      # Mapeia a porta do Vite (3000) para a sua máquina local (3000)
      - "3000:3000"

    volumes:
      - ./frontend:/usr/src/app # Sincroniza a pasta local 'frontend'

# Volumes para persistência de dados
volumes:
  db_data:
